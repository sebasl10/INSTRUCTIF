<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="style_dashboardintervenant.css">
    </head>
    <body>
        <h1>Dashboard Intervenant</h1>
        <button id="bouton-seance">üîî</button>

        <div class="container">
            <div id="statistiques">
                <h2>Statistiques</h2>
            </div>
            <div id="historique">
                <h2>Historique des soutiens</h2>
                <ul id="liste_historique"></ul>
                <p id="message"></p>
            </div>
        </div>
        
        <div id="container-pop-up">
            <div id="pop-up">
                <h2>Prochaine S√©ance</h2>
                <div id="infos_eleve">
                    <p id="nom_eleve"></p>
                    <p id="classe_eleve"></p>
                    <p id="details_eleve"></p>
                </div>
                <div id="infos_ecole">
                    
                </div>
                <button id="fermer-pop-up">‚úñ</button>
                <button id="accepter-soutien">Accepter</button>
            </div>
        </div>
        
        
        <script>
            $(document).ready(function() { 
                console.log("Appel AJAX Charger Infos Intervenant");
                $.ajax({
                    url: "./ActionServlet",
                    type: "POST",
                    data: { todo: "ProfilIntervenant" },
                    dataType: "json"
                })
                .done(function(response) {
                    let idSoutien = null;
                    let monIntervenant = response;
                    let listeSoutienHtml = $("#liste_historique");
                    listeSoutienHtml.empty();

                    for (const soutien of monIntervenant.historique) {
                        idSoutien = soutien.id;
                        let item = $("<li>");
                        let corps = $("<div>").append(
                            $("<div>").text("S√©ance du " + soutien.dateDemande),
                            $("<p>").text("El√®ve : " + soutien.eleve.prenom + " " + soutien.eleve.nom),
                            $("<p>").text("Mati√®re : " + soutien.matiere.nom),
                            $("<p>").text("D√©tails : " + soutien.details)
                        );

                        let feedbackElem;
                        console.log(soutien);
                        if (soutien.feedback && soutien.feedback.trim() !== "") {
                            feedbackElem = $("<p>").text("Feedback : " + soutien.feedback);
                            corps.append(feedbackElem);
                        } else {
                            const input = $("<input>").attr({
                                type: "text",
                                placeholder: "Entrer un feedback...",
                                class: "champ-feedback"
                            });
                            const btn = $("<button>")
                                .text("Valider")
                                .addClass("btn-valider-feedback")
                                .click(function() {
                                    const nouveauFeedback = input.val();
                                    if (nouveauFeedback.trim() !== "") {
                                        $.ajax({
                                            url: "./ActionServlet",
                                            type: "POST",
                                            data: { todo: "AjouterFeedback", feedback: nouveauFeedback, id : idSoutien },
                                            
                                        })
                                        .done(function(response) {
                                            input.remove();
                                            btn.remove();
                                            const pFeedback = $("<p>").text("Feedback : " + nouveauFeedback);
                                            corps.append(pFeedback);
                                        })
                                        .fail(function(error) {
                                            console.error("Erreur AJAX :", error);
                                        });
                                        
                                    }
                                });
                            corps.append(input, btn);
                        }
                        item.append(corps);
                        listeSoutienHtml.append(item);
                    }
                })
                .fail(function(error) {
                    $("#message").text("Erreur");
                });
            });
            
            let ouvrir_demande = document.getElementById("bouton-seance");
            ouvrir_demande.addEventListener("click", function () {
                document.getElementById('container-pop-up').style.display = 'block';

                $.ajax({
                    url: './ActionServlet',
                    type: 'POST',
                    data: { todo: 'RecupererProchainSoutien' },
                    datatype: 'json'
                })
                .done(function (response) {
                    console.log("R√©ponse AJAX soutien :", response);
                    let soutien = response;
                    let infos_eleve = $("#infos_eleve"); 
                    infos_eleve.empty();
                    infos_eleve.append($("<p>").text("El√®ve : " + soutien.eleve.prenom + " " + soutien.eleve.nom));
                    infos_eleve.append($("<p>").text("Classe : " + soutien.eleve.classe));
                    infos_eleve.append($("<p>").text("D√©tails : " + soutien.details));
                })
                .fail(function (error) {
                    console.error("Erreur AJAX :", error);
                    alert("Erreur lors de la r√©cup√©ration du soutien.");
                });
            });
            
            let fermer_demande = document.getElementById("fermer-pop-up");
            fermer_demande.addEventListener("click", function(){
                document.getElementById('container-pop-up').style.display = 'none';
            });
            $("#accepter-soutien").click(function(){
                $.ajax({
                    url: './ActionServlet',
                    type: 'POST',
                    data: { todo: 'AccepterSoutien' },
                    datatype: 'json'
                }).done(function (){}).fail({});
            });

        </script>

    </body>
</html>
